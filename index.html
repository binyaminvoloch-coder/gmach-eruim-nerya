<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
   <title>גמ"ח אירועים נריה - השאלת ציוד לאירועים ושמחות | הזמנה אונליין</title>
    <meta name="description" content="השאלת ציוד לאירועים בנריה והסביבה. גמ"ח נריה מציע מגוון רחב של ציוד: שולחנות, כיסאות, מפות, כלי הגשה ועוד. בדקו זמינות והזמינו אונליין בקלות.">
    <meta name="keywords" content="גמח נריה, ציוד לאירועים, השאלת כיסאות, השאלת שולחנות, גמ"ח אירועים, נריה, ציוד לשמחות, השכרת ציוד לאירועים">
    <meta name="author" content="גמח אירועים נריה">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://gmach-eruim-nerya.vercel.app/" />
    
    <meta property="og:title" content="גמ&quot;ח אירועים נריה - קטלוג והזמנות">
    <meta property="og:description" content="מערכת הזמנות חכמה לציוד אירועים. היכנסו לצפייה בקטלוג ובדיקת זמינות.">
    <meta property="og:image" content="preview.jpg">
    <meta property="og:url" content="https://gmach-eruim-nerya.vercel.app/">
    <meta property="og:type" content="website">

    <!-- Schema.org Markup for Local Business/Organization -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "LocalBusiness",
      "name": "גמ\"ח אירועים נריה",
      "image": "preview.jpg",
      "address": {
        "@type": "PostalAddress",
        "addressLocality": "Neria",
        "addressCountry": "IL"
      },
      "geo": {
        "@type": "GeoCoordinates",
        "latitude": 31.936,
        "longitude": 35.138
      },
      "description": "השאלת ציוד לאירועים, שמחות ושבתות ביישוב נריה.",
      "openingHours": "Su-Th 10:00-17:30"
    }
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
 .hero-section {
            background: linear-gradient(to bottom, rgba(26, 28, 44, 0.2), rgba(26, 28, 44, 0.5)),
                        url('preview.jpg');
            /* cover מבטיח שהתמונה תמלא את כל השטח בלי להתעוות */
            background-size: cover; 
            /* מרכז את התמונה כדי שיראו גם תקרה וגם רצפה */
            background-position: center; 
            background-repeat: no-repeat;
            background-attachment: scroll; /* עדיף לניידים */
        }
        .step-active { color: var(--gold); border-bottom: 3px solid var(--gold); }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid var(--gold); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #toast { position: fixed; bottom: 20px; right: 20px; transform: translateY(150%); transition: transform 0.3s ease; z-index: 1000; background-color: var(--navy); color: white; padding: 1rem 1.5rem; border-radius: 1rem; border-right: 4px solid var(--gold); }
        #toast.show { transform: translateY(0); }
        #whatsapp-float { position: fixed; bottom: 20px; left: 20px; z-index: 999; background: #25D366; color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 20px rgba(0,0,0,0.2); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        @media print { .no-print { display: none !important; } body { background: white; } #print-area { display: block !important; } }
        details summary::-webkit-details-marker { display:none; }
        
        .map-container iframe { width: 100%; height: 100%; border: 0; filter: grayscale(20%) contrast(1.2) opacity(0.9); border-radius: 1.5rem; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* אנימציית תעופה לעגלה */
        .fly-item {
            position: fixed;
            z-index: 1000;
            width: 20px;
            height: 20px;
            background: var(--gold);
            border-radius: 50%;
            pointer-events: none;
            transition: transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.6s ease;
        }
        
        /* עיצוב לאינפוטים של תאריך */
        input[type="date"] { cursor: pointer; }
    </style>
</head>
<body class="text-slate-800">
    <div id="toast" class="shadow-2xl flex items-center gap-3">
        <i data-lucide="info" class="text-gold"></i>
        <span id="toast-msg"></span>
    </div>

    <!-- Lightbox Modal -->
    <div id="lightbox" onclick="this.classList.add('hidden')" class="hidden fixed inset-0 bg-black/90 z-[300] flex items-center justify-center p-4 cursor-pointer backdrop-blur-sm no-print">
        <img id="lightbox-img" src="" alt="תצוגה מוגדלת" class="max-w-full max-h-[90vh] rounded-lg shadow-2xl border-2 border-gold object-contain transition-transform transform scale-95 duration-200" onclick="event.stopPropagation()">
        <button onclick="document.getElementById('lightbox').classList.add('hidden')" class="absolute top-4 right-4 text-white/80 hover:text-white p-2 bg-white/10 rounded-full" aria-label="סגור תמונה"><i data-lucide="x"></i></button>
        <p class="absolute bottom-10 text-white/70 text-sm">לחץ בכל מקום לסגירה</p>
    </div>

    <a href="https://wa.me/972543040965" target="_blank" id="whatsapp-float" class="no-print" aria-label="צור קשר בוואטסאפ">
        <i data-lucide="message-circle" class="w-8 h-8"></i>
    </a>

    <header class="hero-section min-h-[45vh] md:min-h-[55vh] flex flex-col relative text-white no-print">
        <nav class="p-4 md:p-6 flex justify-between items-center max-w-7xl mx-auto w-full z-20">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 md:w-12 md:h-12 gold-gradient rounded-full flex items-center justify-center shadow-lg">
                    <i data-lucide="sparkles" class="text-navy w-5 h-5 md:w-6 md:h-6"></i>
                </div>
                <div>
                    <!-- שינוי סמנטי ל-SEO: זה כבר לא H1 אלא טקסט לוגו -->
                    <div class="text-xl md:text-2xl font-bold serif italic leading-none">לשמחות בכל עת</div>
                    <p class="text-[9px] md:text-[10px] tracking-[0.2em] uppercase opacity-70">Luxury Event Rentals</p>
                </div>
            </div>
            
            <div class="flex items-center gap-4 md:gap-6">
                <!-- כפתורים לדסקטופ -->
                <button onclick="lookupOrder()" class="opacity-60 hover:opacity-100 transition-opacity text-xs font-bold tracking-widest border-l border-white/20 pl-6 hidden md:block">חיפוש/עריכת הזמנה</button>
                <button onclick="showAdminLogin()" class="opacity-60 hover:opacity-100 transition-opacity text-xs font-bold tracking-widest transform md:translate-x-5 hidden md:block">ניהול מלאי</button>
                
                <!-- כפתור תפריט למובייל -->
                <button onclick="toggleMobileMenu()" class="md:hidden p-2 text-white hover:bg-white/10 rounded-lg transition-colors" aria-label="תפריט">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>

                <!-- כפתור עגלה -->
                <button id="cart-btn-icon" onclick="toggleCart(true)" class="relative bg-white/10 p-3 md:p-4 rounded-2xl backdrop-blur-md border border-white/20 hover:bg-white/20 transition-all" aria-label="עגלת קניות">
                    <i data-lucide="shopping-cart" class="w-5 h-5 md:w-6 md:h-6"></i>
                    <span id="cart-count" class="absolute -top-2 -right-2 gold-gradient text-navy text-[11px] font-extrabold w-6 h-6 rounded-full flex items-center justify-center border-2 border-navy hidden">0</span>
                </button>
            </div>
        </nav>
        
        <!-- תפריט נפתח למובייל -->
        <div id="mobile-menu" class="hidden absolute top-[70px] left-0 right-0 bg-navy/95 backdrop-blur-xl border-t border-white/10 p-4 z-50 flex flex-col gap-4 md:hidden shadow-2xl">
            <button onclick="lookupOrder(); toggleMobileMenu()" class="flex items-center gap-3 text-white p-3 rounded-xl hover:bg-white/10 border border-white/5">
                <i data-lucide="search" class="text-gold w-5 h-5"></i>
                <span class="font-bold">חיפוש/עריכת הזמנה</span>
            </button>
            <button onclick="showAdminLogin(); toggleMobileMenu()" class="flex items-center gap-3 text-white p-3 rounded-xl hover:bg-white/10 border border-white/5">
                <i data-lucide="lock" class="text-gold w-5 h-5"></i>
                <span class="font-bold">ניהול מלאי</span>
            </button>
        </div>
        
        <div class="flex-1 flex flex-col items-center justify-center text-center px-4 z-10 space-y-4 md:space-y-8 pb-8">
            <div>
                <!-- שינוי סמנטי ל-SEO: זה ה-H1 האמיתי של העמוד -->
                <h1 class="text-4xl md:text-7xl font-bold mb-2 md:mb-4 serif">גמ"ח אירועים נריה</h1>
                <p class="text-lg md:text-xl text-white/80 max-w-2xl font-light mx-auto">ציוד מושלם לאירועים, שמחות והתכנסויות.</p>
            </div>

            <div class="bg-white/10 backdrop-blur-md border border-white/20 p-3 md:p-4 rounded-2xl flex flex-col md:flex-row items-center gap-2 md:gap-4 text-xs md:text-sm font-bold tracking-wide">
                <div class="flex items-center gap-2">
                    <i data-lucide="clock" class="text-gold w-4 h-4 md:w-5 md:h-5"></i>
                    <span>שעות פתיחה: 10:00 | 17:30</span>
                </div>
                <div class="hidden md:block w-px h-4 bg-white/20"></div>
                <div class="text-gold bg-navy/50 px-3 py-1 rounded-lg text-[10px] md:text-xs border border-gold/30">
                    בתיאום מראש בלבד
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-6 md:py-12 no-print">
        
        <!-- Smart Availability Check Section -->
        <div class="bg-white rounded-[2rem] p-6 mb-8 shadow-lg border border-gold/20 relative z-30 -mt-16 md:-mt-20">
            <h2 class="sr-only">בדיקת זמינות ציוד</h2> <!-- כותרת נסתרת עבור קוראי מסך ומנועי חיפוש -->
            <div class="flex flex-col lg:flex-row items-end gap-4 lg:gap-6">
                <div class="flex-1 w-full grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-navy mb-2 mr-1 uppercase tracking-wider flex items-center gap-1">
                            <i data-lucide="calendar" class="w-3 h-3 text-gold"></i> תאריך איסוף
                        </label>
                        <input type="date" id="filter-p-date" onchange="handleDateFilter()" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 focus:ring-2 focus:ring-gold focus:border-transparent outline-none text-sm transition-all">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-navy mb-2 mr-1 uppercase tracking-wider flex items-center gap-1">
                            <i data-lucide="calendar-check" class="w-3 h-3 text-gold"></i> תאריך החזרה
                        </label>
                        <input type="date" id="filter-r-date" onchange="handleDateFilter()" class="w-full p-3 bg-gray-50 rounded-xl border border-gray-200 focus:ring-2 focus:ring-gold focus:border-transparent outline-none text-sm transition-all">
                    </div>
                </div>
                <div class="flex gap-2 w-full lg:w-auto">
                    <button onclick="setNextShabbatFilter()" class="flex-1 lg:flex-none px-6 py-3 bg-navy/5 text-navy rounded-xl border border-navy/10 hover:bg-navy hover:text-white transition-all text-xs font-bold whitespace-nowrap">
                        לשבת הקרובה
                    </button>
                    <button onclick="clearDateFilter()" class="px-4 py-3 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-xl transition-all" title="נקה תאריכים" aria-label="נקה תאריכים">
                        <i data-lucide="x-circle" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
            <div id="availability-message" class="hidden mt-3 text-xs text-center font-bold text-gold bg-navy/5 p-2 rounded-lg">
                הקטלוג מציג זמינות לתאריכים שנבחרו
            </div>
        </div>

        <!-- Sticky Header Container -->
        <div class="sticky top-0 z-40 bg-[#fcfcfc]/95 backdrop-blur-md py-4 -mx-4 px-4 border-b border-gray-100 transition-shadow mb-6 shadow-sm">
            <div class="flex flex-col md:flex-row justify-between items-end gap-4 md:gap-6">
                <div class="space-y-2 md:space-y-4 w-full md:w-auto overflow-hidden">
                    <h3 class="text-sm font-bold uppercase tracking-widest text-gold">הקטלוג שלנו</h3>
                    <!-- כאן יופיעו הקטגוריות -->
                    <div class="flex items-center gap-2 overflow-x-auto pb-2 no-scrollbar scroll-smooth" id="category-filters" style="max-width: 100vw;"></div>
                </div>
                <div class="relative w-full md:w-80">
                    <input type="text" id="searchInput" oninput="handleSearch()" placeholder="חפש פריט בקטלוג..."
                        class="w-full pl-12 pr-6 py-3 md:py-3.5 rounded-2xl bg-white border border-gray-100 shadow-sm focus:ring-2 focus:ring-gold transition-all outline-none">
                    <i data-lucide="search" class="absolute left-4 top-3 md:top-3.5 text-gray-400 w-5 h-5"></i>
                </div>
            </div>
        </div>
        
        <div id="inventory-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 md:gap-8 mb-12 md:mb-20">
            <div class="col-span-full text-center py-20"><div class="loader mx-auto mb-4"></div>טוען פריטים...</div>
        </div>

        <!-- Location Section -->
        <div class="bg-white rounded-[2rem] md:rounded-[2.5rem] p-6 md:p-10 shadow-xl border border-gray-100 flex flex-col md:flex-row gap-8 items-center justify-between">
            <div class="w-full md:w-1/2 space-y-6">
                <div>
                    <h3 class="text-2xl font-bold serif text-navy mb-2">אנחנו כאן בשבילכם</h3>
                    <p class="text-gray-500 text-sm md:text-base">הגמ"ח ממוקם ביישוב נריה. האיסוף וההחזרה מתבצעים מהמחסן בתיאום מראש בלבד בשעות הפעילות. המקום מספק מענה לתושבי נריה והסביבה לכל צורך של ציוד לאירועים.</p>
                </div>
                <div class="flex gap-3 md:gap-4">
                    <a href="https://waze.com/ul?ll=31.936,35.138&navigate=yes" target="_blank" rel="noopener noreferrer" class="flex-1 flex items-center justify-center gap-2 bg-[#33CCFF] hover:bg-[#2cb5e3] text-white py-3 px-4 md:px-6 rounded-xl font-bold transition-transform hover:scale-105 shadow-lg shadow-blue-200 text-sm md:text-base">
                        <i data-lucide="navigation" class="w-4 h-4 md:w-5 md:h-5"></i>
                        נווט עם Waze
                    </a>
                    <a href="https://maps.app.goo.gl/9kXN5j1Qo8QPpA796?g_st=aw" target="_blank" rel="noopener noreferrer" class="flex-1 flex items-center justify-center gap-2 bg-gray-100 hover:bg-gray-200 text-navy py-3 px-4 md:px-6 rounded-xl font-bold transition-colors text-sm md:text-base">
                        <i data-lucide="map-pin" class="w-4 h-4 md:w-5 md:h-5"></i>
                        גוגל מפות
                    </a>
                </div>
            </div>
            <div class="w-full md:w-1/2 h-56 md:h-80 bg-gray-200 rounded-[1.5rem] map-container shadow-inner overflow-hidden relative">
                <iframe 
                    title="מפת הגעה לגמ&quot;ח נריה"
                    src="https://maps.google.com/maps?q=נריה&t=&z=15&ie=UTF8&iwloc=&output=embed" 
                    frameborder="0" scrolling="no" marginheight="0" marginwidth="0">
                </iframe>
                <div class="absolute inset-0 pointer-events-none border-[6px] border-white/50 rounded-[1.5rem]"></div>
            </div>
        </div>
    </main>

    <!-- Cart Sidebar -->
    <div id="cart-sidebar" class="fixed inset-0 bg-navy/60 backdrop-blur-sm z-[100] transition-opacity duration-300 opacity-0 pointer-events-none no-print" onclick="toggleCart(false)">
        <div class="fixed inset-y-0 left-0 w-full md:w-[500px] bg-white shadow-2xl transform -translate-x-full transition-transform duration-500 flex flex-col" onclick="event.stopPropagation()">
            
            <!-- כפתור סגירה למובייל -->
            <button onclick="toggleCart(false)" class="absolute top-4 left-4 z-50 p-2 bg-gray-100 rounded-full text-gray-600 hover:bg-gray-200 shadow-sm md:hidden">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>

            <div id="cart-stepper" class="flex border-b text-center text-[11px] font-bold uppercase tracking-[0.2em] text-gray-400 mt-2 md:mt-0">
                <div id="step-1-header" class="flex-1 py-6 step-active transition-colors">01. סל פריטים</div>
                <div id="step-2-header" class="flex-1 py-6 transition-colors">02. תזמון ופרטים</div>
                <div id="step-3-header" class="flex-1 py-6 transition-colors">03. אישור</div>
            </div>
            <div id="cart-content" class="flex-1 overflow-y-auto p-8"></div>
            <div id="mini-summary" class="hidden px-8 py-3 bg-gray-50 border-t border-b text-xs flex justify-between items-center">
                <div class="flex flex-col">
                    <span class="font-bold">פריטים שנבחרו: <span id="summary-count">0</span></span>
                    <span id="active-order-label" class="text-gold font-bold hidden">עריכת הזמנה פעילה</span>
                </div>
                <button onclick="goToStep(1)" class="text-gold underline">עריכה</button>
            </div>
            <div id="cart-footer" class="p-8 bg-white border-t space-y-4">
                <div id="cancel-order-area" class="hidden pb-4">
                    <button onclick="cancelCurrentOrder()" class="w-full py-3 text-red-500 text-xs font-bold border border-red-100 rounded-xl hover:bg-red-50 transition-colors">ביטול ומחיקת ההזמנה לחלוטין</button>
                </div>
                <div class="flex gap-3">
                    <button id="prevBtn" onclick="prevStep()" class="hidden flex-1 py-4 rounded-2xl border border-gray-200 font-bold hover:bg-gray-50 transition-colors">חזור</button>
                    <button id="nextBtn" onclick="nextStep()" class="flex-[2] gold-gradient py-4 rounded-2xl font-bold text-navy shadow-xl hover:scale-[1.02] active:scale-95 transition-all">המשך</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Modal -->
    <div id="admin-modal" class="fixed inset-0 bg-navy/80 backdrop-blur-md z-[200] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-[2rem] w-full max-w-5xl max-h-[90vh] overflow-hidden flex flex-col shadow-2xl">
            <div class="p-8 bg-[#0b1f3a] text-[#f5d37a] flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-bold serif italic leading-none text-[#f5d37a]">ניהול הגמ"ח</h2>
                    <p id="admin-subtitle" class="text-[10px] uppercase tracking-widest mt-2 text-[#e6c46f] opacity-70">Inventory & Order Management</p>
                </div>
                <div class="flex items-center gap-4">
                    <button id="admin-view-toggle" onclick="showOrdersHistory()" class="px-4 py-2 bg-[#132f55] text-[#f5d37a] rounded-xl hover:bg-white/10 text-xs font-bold transition-colors hidden md:block">היסטוריית הזמנות</button>
                    <button onclick="closeAdmin()" class="p-2 -mt-1 text-[#f5d37a] bg-white/10 rounded-full hover:bg-white/20 transition-colors"><i data-lucide="x"></i></button>
                </div>
            </div>
            <div class="md:hidden p-4 bg-[#132f55] border-t border-white/10">
                 <button onclick="showOrdersHistory()" class="w-full py-2 bg-white/10 text-[#f5d37a] rounded-xl text-xs font-bold">היסטוריית הזמנות</button>
            </div>
            <div id="admin-content" class="flex-1 overflow-y-auto p-8"></div>
        </div>
    </div>

    <!-- Print Layout -->
    <div id="print-area" class="hidden text-right p-16">
        <div class="border-b-4 border-navy pb-4 mb-8">
            <h1 class="text-4xl font-bold serif italic">גמ"ח אירועים נריה - אישור השאלה</h1>
            <p id="print-order-id" class="text-xl font-bold mt-2 text-gold"></p>
        </div>
        <div id="print-user-info" class="mb-8 space-y-2 text-lg"></div>
        <table class="w-full border-collapse border border-gray-300">
            <thead><tr class="bg-navy text-white"><th class="p-3 border border-gray-300">פריט</th><th class="p-3 border border-gray-300">כמות</th></tr></thead>
            <tbody id="print-items-list"></tbody>
        </table>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzn7kbiKQHLmqC3We50VnDpjGj3JkkC8Yg8dwB2LPUiyCjMvwoixdnIJQVfIDjiCf4p/exec';
        const DEFAULT_IMG = 'https://images.unsplash.com/photo-1511795409834-ef04bbd61622?auto=format&fit=crop&q=80&w=800';
      
        let inventory = [];
        let orders = [];
        let cart = JSON.parse(localStorage.getItem('gemach_cart')) || [];
        let currentStep = 1;
        let currentCategory = 'הכל';
        let activeOrderCode = null;
        let pendingFormData = {}; // Holds name, phone, dates etc.

        function formatImageUrl(url) {
            if (!url) return DEFAULT_IMG;
            if (url.includes('drive.google.com') || url.includes('docs.google.com')) {
                let id = '';
                try {
                    if (url.includes('id=')) {
                        id = url.split('id=')[1].split('&')[0];
                    } else if (url.includes('/d/')) {
                        id = url.split('/d/')[1].split('/')[0];
                    }
                } catch (e) { console.error("Error parsing Drive URL", e); }
                if (id) return `https://lh3.googleusercontent.com/u/0/d/${id}=w1000`;
            }
            return url;
        }

        async function init() {
            try {
                const res = await fetch(SCRIPT_URL);
                const data = await res.json();
                inventory = (data.Inventory || []).map(i => ({
                    ...i,
                    status: (i['תיאור אפשרי'] && i['תיאור אפשרי'].trim().toLowerCase() === 'hidden') ? 'hidden' : 'active',
                    מלאי: parseInt(i.מלאי || i['מלאי'] || 0)
                }));
                orders = data.Orders || [];
                renderCategories(); 
                renderGrid();
                updateCartUI();
                if (window.lucide) lucide.createIcons();
            } catch (e) { 
                console.error(e);
                showToast('שגיאה בטעינת הנתונים'); 
            }
        }

        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('hidden');
        }

        function renderCategories() {
            const categories = ['הכל', ...new Set(inventory.map(i => i.קטגוריה).filter(Boolean))];
            const container = document.getElementById('category-filters');
            
            container.innerHTML = categories.map(cat => {
                const isActive = currentCategory === cat;
                return `
                    <button onclick="filterByCategory('${cat}')" 
                        class="px-5 py-2 rounded-full text-xs font-bold border transition-all whitespace-nowrap ${isActive 
                            ? 'bg-navy text-gold border-navy shadow-md scale-105' 
                            : 'bg-white text-gray-500 border-gray-200 hover:border-gold hover:text-navy'}">
                        ${cat}
                    </button>
                `;
            }).join('');
        }

        function filterByCategory(cat) {
            currentCategory = cat;
            renderCategories();
            
            if (cat === 'הכל') {
                renderGrid(inventory.filter(item => item.status !== 'hidden'));
            } else {
                const filtered = inventory.filter(i => i.status !== 'hidden' && i.קטגוריה === cat);
                renderGrid(filtered);
            }
        }

        // --- פונקציות לסינון תאריכים גלובלי (השאלה חכמה) ---

        function handleDateFilter() {
            const pDate = document.getElementById('filter-p-date').value;
            const rDate = document.getElementById('filter-r-date').value;
            
            if (pDate) pendingFormData.pDate = pDate;
            if (rDate) pendingFormData.rDate = rDate;

            if (pDate && rDate) {
                document.getElementById('availability-message').classList.remove('hidden');
                showToast("הקטלוג סונן לפי זמינות לתאריכים הנבחרים");
            } else {
                document.getElementById('availability-message').classList.add('hidden');
            }
            
            // רינדור מחדש עם הזמינות המעודכנת
            const filteredItems = currentCategory === 'הכל' 
                ? inventory.filter(item => item.status !== 'hidden')
                : inventory.filter(item => item.status !== 'hidden' && item.קטגוריה === currentCategory);
            renderGrid(filteredItems);
        }

        function clearDateFilter() {
            document.getElementById('filter-p-date').value = '';
            document.getElementById('filter-r-date').value = '';
            pendingFormData.pDate = '';
            pendingFormData.rDate = '';
            document.getElementById('availability-message').classList.add('hidden');
            handleDateFilter(); // רענון הגריד ללא סינון
        }

        function setNextShabbatFilter() {
             const today = new Date();
            const friday = new Date(today);
            friday.setDate(today.getDate() + (5 - today.getDay() + 7) % 7);
            if(today.getDay() >= 5) friday.setDate(friday.getDate() + 7);

            const sunday = new Date(friday);
            sunday.setDate(friday.getDate() + 2);

            const formatDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            document.getElementById('filter-p-date').value = formatDate(friday);
            document.getElementById('filter-r-date').value = formatDate(sunday);
            handleDateFilter();
        }

        // --- סוף לוגיקת תאריכים ---

        function getAvailableStock(itemName, pDate, rDate) {
            const item = inventory.find(i => i.שם_פריט === itemName);
            if (!item) return 0;

            const isTablecloth = (item['קטגוריה'] || '').includes('מפות');
            const bufferDays = isTablecloth ? 1 : 0;

            let totalInUse = 0;
            const start = new Date(pDate);
            const end = new Date(rDate);

            orders.forEach(order => {
                const currentOrderCode = String(order.קוד_הזמנה || order.orderCode || order['קוד_הזמנה'] || '').trim();
                const activeCode = String(activeOrderCode || '').trim();

                if (activeOrderCode && currentOrderCode === activeCode) return;
                
                const orderStart = new Date(order.תאריך_לקיחה);
                let orderEnd = new Date(order.תאריך_החזרה);

                if (isTablecloth) {
                    orderEnd.setDate(orderEnd.getDate() + bufferDays);
                }

                if (start <= orderEnd && end >= orderStart) {
                    try {
                        const rawCart = JSON.parse(order.raw_cart || '[]');
                        const orderItem = rawCart.find(oi => oi.שם_פריט === itemName);
                        if (orderItem) totalInUse += parseInt(orderItem.qty);
                    } catch(e) {}
                }
            });
            return Math.max(0, item.מלאי - totalInUse);
        }

        function renderGrid(items = inventory.filter(item => item.status !== 'hidden')) {
            const grid = document.getElementById('inventory-grid');
            const hasDates = pendingFormData.pDate && pendingFormData.rDate;

            grid.innerHTML = items.map(item => {
                // חישוב מלאי דינמי להצגה
                let displayStock = item.מלאי;
                if (hasDates) {
                    displayStock = getAvailableStock(item.שם_פריט, pendingFormData.pDate, pendingFormData.rDate);
                }

                const cartItem = cart.find(c => c.שם_פריט === item.שם_פריט);
                const inCart = cartItem ? cartItem.qty : 0;
                
                // האם המלאי אזל (בהתחשב בתאריכים)?
                const isOutOfStock = displayStock <= 0;
                
                // SEO FIX: Adding alt text to images
                const itemNameSafe = item.שם_פריט.replace(/"/g, '&quot;');
                const categorySafe = (item.קטגוריה || 'כללי').replace(/"/g, '&quot;');

                return `
                    <div class="bg-white rounded-[2rem] card-shadow overflow-hidden group border border-transparent hover:border-gold/20 flex flex-col h-full ${isOutOfStock ? 'opacity-75 grayscale' : ''}">
                        <div class="h-64 overflow-hidden relative bg-gray-100 cursor-zoom-in" onclick="openImage('${formatImageUrl(item.תמונה)}')">
                            <img src="${formatImageUrl(item.תמונה)}" alt="${itemNameSafe} - השאלת ציוד ${categorySafe}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110">
                            <div class="absolute bottom-2 right-2 bg-white/90 backdrop-blur-sm px-2 py-1 rounded-lg text-[10px] font-bold text-navy shadow-sm">
                                ${item.קטגוריה || 'כללי'}
                            </div>
                            ${isOutOfStock ? `<div class="absolute inset-0 bg-navy/30 flex items-center justify-center"><span class="bg-red-500 text-white px-3 py-1 rounded-lg font-bold text-xs shadow-lg transform -rotate-6">אזל לתאריכים אלו</span></div>` : ''}
                        </div>
                        <div class="p-6 flex flex-col flex-1">
                            <h3 class="font-bold text-lg text-navy">${item.שם_פריט}</h3>
                            <p class="text-xs ${hasDates ? 'text-gold font-bold' : 'text-gray-500'} mb-4">
                                ${hasDates ? `פנוי לתאריך הנבחר: ${displayStock}` : `במלאי כולל: ${item.מלאי}`}
                            </p>
                            <div class="mt-auto flex items-center justify-between">
                                <div class="flex items-center gap-3 bg-gray-50 p-1 rounded-xl">
                                    <button onclick="updateQty('${item.שם_פריט}', -1)" class="w-8 h-8 flex items-center justify-center hover:bg-white rounded-lg transition-colors" aria-label="הפחת כמות">-</button>
                                    <span class="w-6 text-center font-bold">${inCart}</span>
                                    <button onclick="updateQty('${item.שם_פריט}', 1); animateFlyToCart(event)" 
                                        ${isOutOfStock ? 'disabled' : ''}
                                        class="w-8 h-8 flex items-center justify-center hover:bg-white rounded-lg transition-colors ${isOutOfStock ? 'cursor-not-allowed text-gray-400' : ''}" aria-label="הוסף כמות">+</button>
                                </div>
                                <button onclick="toggleCart(true)" class="text-gold p-2 hover:bg-gold/10 rounded-full transition-colors" aria-label="צפה בעגלה"><i data-lucide="shopping-bag"></i></button>
                            </div>
                        </div>
                    </div>`;
            }).join('');
            lucide.createIcons();
        }

        function animateFlyToCart(event) {
            if(!event) return;
            const btn = event.target;
            const cartIcon = document.getElementById('cart-btn-icon');
            if (!cartIcon) return;

            const flyer = document.createElement('div');
            flyer.classList.add('fly-item');
            
            const btnRect = btn.getBoundingClientRect();
            flyer.style.top = `${btnRect.top}px`;
            flyer.style.left = `${btnRect.left}px`;
            document.body.appendChild(flyer);

            const cartRect = cartIcon.getBoundingClientRect();
            // חישוב המרכז של העגלה ושל הפריט
            const xDiff = (cartRect.left + cartRect.width/2) - (btnRect.left + btnRect.width/2);
            const yDiff = (cartRect.top + cartRect.height/2) - (btnRect.top + btnRect.height/2);

            requestAnimationFrame(() => {
                flyer.style.transform = `translate(${xDiff}px, ${yDiff}px) scale(0.2)`;
                flyer.style.opacity = '0.5';
            });

            setTimeout(() => flyer.remove(), 600);
        }

        function openImage(url) {
            const box = document.getElementById('lightbox');
            const img = document.getElementById('lightbox-img');
            img.src = url;
            box.classList.remove('hidden');
            requestAnimationFrame(() => img.classList.replace('scale-95', 'scale-100'));
        }

        function updateQty(name, delta) {
            const itemToAdd = inventory.find(i => i.שם_פריט === name);
            const isTableclothItem = (itemToAdd.קטגוריה || '').includes('מפות');

            if (delta > 0 && cart.length > 0) {
                const hasTableclothInCart = cart.some(c => (c.קטגוריה || '').includes('מפות'));
                const hasRegularItemInCart = cart.some(c => !(c.קטגוריה || '').includes('מפות'));

                if (isTableclothItem && hasRegularItemInCart) {
                    return showToast('לא ניתן לערבב הזמנת מפות עם ציוד אחר. נא לפצל להזמנות נפרדות.');
                }
                
                if (!isTableclothItem && hasTableclothInCart) {
                    return showToast('הסל מכיל מפות. לא ניתן להוסיף ציוד אחר להזמנה זו.');
                }
            }

            // שימוש בתאריכים הגלובליים אם קיימים
            const pDate = document.getElementById('p-date')?.value || pendingFormData.pDate;
            const rDate = document.getElementById('r-date')?.value || pendingFormData.rDate;
            
            let limit = itemToAdd.מלאי;
            if (pDate && rDate) {
                limit = getAvailableStock(name, pDate, rDate);
            }

            let cartItem = cart.find(c => c.שם_פריט === name);
            if (!cartItem && delta > 0) {
                if (limit < 1) return showToast('אין מלאי זמין לתאריכים אלו');
                cart.push({...inventory.find(i => i.שם_פריט === name), qty: 1});
            } else if (cartItem) {
                const newQty = cartItem.qty + delta;
                if (newQty > limit) return showToast(`זמינים רק ${limit} לתאריכים אלו`);
                if (newQty <= 0) cart = cart.filter(c => c.שם_פריט !== name);
                else cartItem.qty = newQty;
            }
            saveCart();
            
            // עדכון הגריד בהתאם לקטגוריה
            const filteredItems = currentCategory === 'הכל' 
                ? inventory.filter(item => item.status !== 'hidden')
                : inventory.filter(item => item.status !== 'hidden' && item.קטגוריה === currentCategory);
            renderGrid(filteredItems);

            if (currentStep === 1) renderCartStep1(document.getElementById('cart-content'));
            updateCartUI();
        }

        function toggleCart(show) {
            const s = document.getElementById('cart-sidebar');
            s.classList.toggle('opacity-0', !show);
            s.classList.toggle('pointer-events-none', !show);
            s.querySelector('div').classList.toggle('-translate-x-full', !show);
            if (show) {
                if (!activeOrderCode) {
                    document.getElementById('cancel-order-area').classList.add('hidden');
                }
                document.getElementById('cart-footer').classList.remove('hidden');
                document.getElementById('cart-stepper').classList.remove('hidden');
                goToStep(1);
            }
        }

        function goToStep(s) {
            if (s > currentStep) {
                if (currentStep === 1 && cart.length === 0) return showToast('העגלה ריקה');
                if (currentStep === 2) {
                    const pDate = document.getElementById('p-date').value;
                    const rDate = document.getElementById('r-date').value;
                    const uName = document.getElementById('u-name').value;
                    const uPhone = document.getElementById('u-phone').value;
                    if (!pDate || !rDate || !uName || !uPhone) return showToast('נא למלא את כל הפרטים');
                    
                    for (let c of cart) {
                        const avail = getAvailableStock(c.שם_פריט, pDate, rDate);
                        if (c.qty > avail) return showToast(`המלאי של ${c.שם_פריט} השתנה. זמינים רק ${avail}`);
                    }
                    pendingFormData = { name: uName, phone: uPhone, pDate, rDate, notes: document.getElementById('u-notes').value };
                }
                if (currentStep === 3 && !document.getElementById('terms-checkbox')?.checked) return showToast('חובה לאשר את כללי הגמ"ח');
            }
            currentStep = s;
            document.querySelectorAll('[id^="step-"]').forEach(el => el.classList.remove('step-active'));
            document.getElementById(`step-${s}-header`).classList.add('step-active');
            document.getElementById('prevBtn').classList.toggle('hidden', s === 1);
            
            const cont = document.getElementById('cart-content');
            if (s === 1) renderCartStep1(cont);
            else if (s === 2) renderCartStep2(cont);
            else renderCartStep3(cont);
            lucide.createIcons();
        }

        function renderCartStep1(cont) {
            cont.innerHTML = `<h4 class="font-bold serif text-xl mb-6 text-navy">הסל שלך</h4>` + cart.map(item => `
                <div class="flex items-center gap-4 bg-gray-50 p-4 rounded-2xl mb-3 relative border border-gray-100 shadow-sm">
                    <button onclick="updateQty('${item.שם_פריט}', -${item.qty})" class="absolute top-2 left-2 text-red-400 hover:text-red-600 transition-colors p-1" aria-label="הסר פריט">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                    <img src="${formatImageUrl(item.תמונה)}" alt="${item.שם_פריט}" class="w-14 h-14 rounded-xl object-cover shadow-sm">
                    <div class="flex-1">
                        <div class="text-sm font-bold text-navy">${item.שם_פריט}</div>
                        <div class="text-[10px] text-gray-400">${item.קטגוריה}</div>
                    </div>
                    <div class="flex items-center gap-2 bg-white border border-gray-200 rounded-xl p-1">
                        <button onclick="updateQty('${item.שם_פריט}', -1)" class="w-6 h-6 flex items-center justify-center hover:bg-gray-50 rounded">-</button>
                        <span class="w-4 text-center text-xs font-bold">${item.qty}</span>
                        <button onclick="updateQty('${item.שם_פריט}', 1)" class="w-6 h-6 flex items-center justify-center hover:bg-gray-50 rounded">+</button>
                    </div>
                </div>`).join('');
            lucide.createIcons();
        }

        function setNextShabbat() {
            const today = new Date();
            const friday = new Date(today);
            friday.setDate(today.getDate() + (5 - today.getDay() + 7) % 7);
            if(today.getDay() >= 5) friday.setDate(friday.getDate() + 7);

            const sunday = new Date(friday);
            sunday.setDate(friday.getDate() + 2);

            const formatDate = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            document.getElementById('p-date').value = formatDate(friday);
            document.getElementById('r-date').value = formatDate(sunday);
            
            showToast('עודכנו תאריכים לשבת הקרובה');
        }

        function renderCartStep2(cont) {
            // אם יש תאריכים ב-pendingFormData (מהסינון הראשי), נשתמש בהם
            const defaultP = pendingFormData.pDate || '';
            const defaultR = pendingFormData.rDate || '';

            cont.innerHTML = `
                <div class="space-y-5">
                    <h4 class="font-bold serif text-xl text-navy">פרטי התקשרות ותאריכים</h4>
                    
                    <button onclick="setNextShabbat()" class="w-full py-3 bg-navy/5 text-navy border border-navy/10 rounded-xl text-xs font-bold flex items-center justify-center gap-2 hover:bg-navy hover:text-white transition-all group">
                        <i data-lucide="calendar-check" class="text-gold group-hover:text-white"></i>
                        הגדר אוטומטית לסוף השבוע הקרוב
                    </button>

                    <input type="text" id="u-name" placeholder="שם מלא" value="${pendingFormData.name || ''}" class="w-full p-4 bg-gray-50 rounded-2xl border-none focus:ring-2 focus:ring-gold transition-all">
                    <input type="tel" id="u-phone" placeholder="מספר טלפון" value="${pendingFormData.phone || ''}" class="w-full p-4 bg-gray-50 rounded-2xl border-none focus:ring-2 focus:ring-gold transition-all">
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-[10px] text-gray-400 block mb-1 mr-1">תאריך לקיחה</label><input type="date" id="p-date" value="${defaultP}" class="w-full p-4 bg-gray-50 rounded-2xl border-none text-sm focus:ring-2 focus:ring-gold transition-all"></div>
                        <div><label class="text-[10px] text-gray-400 block mb-1 mr-1">תאריך החזרה</label><input type="date" id="r-date" value="${defaultR}" class="w-full p-4 bg-gray-50 rounded-2xl border-none text-sm focus:ring-2 focus:ring-gold transition-all"></div>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-2xl text-xs text-blue-800 flex gap-2">
                        <i data-lucide="info" class="w-4 h-4 shrink-0"></i>
                        <span>שימו לב: בהזמנת מפות, תיתכן חסימת יום נוסף לניקוי.</span>
                    </div>
                    <textarea id="u-notes" placeholder="הערות מיוחדות..." class="w-full p-4 bg-gray-50 rounded-2xl h-24 border-none focus:ring-2 focus:ring-gold transition-all">${pendingFormData.notes || ''}</textarea>
                </div>`;
        }

        function renderCartStep3(cont) {
            cont.innerHTML = `
                <div class="space-y-6">
                   <div class="bg-black text-white p-6 rounded-[2.5rem] shadow-xl border border-gray-800">
                        <p class="text-xs uppercase tracking-widest mb-1 text-gray-400">סיכום עבור</p>
                        <p class="font-bold text-2xl italic text-white">${pendingFormData.name}</p>
                        <p class="text-sm mt-1 text-gray-400">${pendingFormData.pDate} ⇠ ${pendingFormData.rDate}</p>
                    </div>

                    <div class="bg-gray-50 p-6 rounded-[2rem] space-y-3 text-sm border border-gray-100">
                        ${cart.map(c => `<div class="flex justify-between items-center"><span class="text-gray-600">${c.שם_פריט}</span><span class="font-bold text-navy">${c.qty} יח'</span></div>`).join('')}
                    </div>
                    <div class="space-y-4">
                        <details class="bg-gray-100 rounded-2xl p-4 transition-all">
                            <summary class="font-bold text-xs cursor-pointer flex justify-between items-center text-navy">כללי הגמ"ח (חובה לקרוא) <i data-lucide="chevron-down" class="w-4 h-4"></i></summary>
                            <div class="text-[11px] mt-3 space-y-2 text-gray-600 leading-relaxed border-t border-gray-200 pt-3">
                                <p>• הציוד מושאל בשמחה, ובאחריות השואל להחזירו נקי ותקין.</p>
                                <p>• איחור בהחזרה עלול למנוע מאדם אחר לקיים את האירוע שלו.</p>
                                <p>• במקרה של נזק, השואל מתחייב לשלם את עלות התיקון.</p>
                                <p>• <b>מפות:</b> יש להחזיר מפות נקיות.</p>
                            </div>
                        </details>
                        <label class="flex items-center gap-3 p-3 bg-gold/5 rounded-2xl border border-gold/10 cursor-pointer">
                            <input type="checkbox" id="terms-checkbox" class="w-5 h-5 text-gold rounded focus:ring-gold"> 
                            <span class="text-xs font-bold text-navy/80">קראתי ואישרתי את כללי הגמ"ח</span>
                        </label>
                    </div>
                </div>`;
            lucide.createIcons();
        }

        async function sendOrder() {
            if (!document.getElementById('terms-checkbox').checked) return showToast('חובה לאשר את הכללים');
            const nextBtn = document.getElementById('nextBtn');
            const originalText = nextBtn.innerText;
            nextBtn.disabled = true;
            nextBtn.innerHTML = '<div class="loader w-5 h-5 mx-auto"></div>';

            const code = activeOrderCode || Math.floor(1000 + Math.random() * 9000).toString();
            const payload = {
                action: activeOrderCode ? "updateOrder" : "addOrder",
                orderCode: code,
                שם_לקוח: pendingFormData.name,
                טלפון: pendingFormData.phone,
                תאריך_לקיחה: pendingFormData.pDate,
                תאריך_החזרה: pendingFormData.rDate,
                פריטים: cart.map(c => `${c.qty}x ${c.שם_פריט}`).join(', '),
                raw_cart: JSON.stringify(cart),
                הערות: pendingFormData.notes
            };

            try {
                await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                populatePrintArea(code);
                renderSuccessState(code);
                activeOrderCode = code;
                localStorage.removeItem('gemach_cart');
                cart = [];
                // איפוס תאריכים אחרי שליחה מוצלחת
                document.getElementById('filter-p-date').value = '';
                document.getElementById('filter-r-date').value = '';
                pendingFormData = {};
                updateCartUI();
                await init();
            } catch (e) { showToast('שגיאה בשליחה'); nextBtn.disabled = false; nextBtn.innerText = originalText; }
        }

        function renderSuccessState(code) {
            document.getElementById('cart-footer').classList.add('hidden');
            document.getElementById('cart-stepper').classList.add('hidden');
            document.getElementById('mini-summary').classList.add('hidden');
            
            document.getElementById('cart-content').innerHTML = `
                <div class="text-center space-y-8 py-10">
                    <div class="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto shadow-sm">
                        <i data-lucide="check-circle-2" class="w-12 h-12"></i>
                    </div>
                    <div>
                        <h3 class="text-3xl font-bold serif italic text-navy">ההזמנה נשלחה!</h3>
                        <p class="text-gray-500 mt-2">קיבלנו את פרטי ההזמנה שלך.</p>
                    </div>
                    <div class="bg-black text-white p-8 rounded-[2.5rem] shadow-2xl border-b-4 border-yellow-600">
                        <p class="text-sm opacity-80 uppercase tracking-widest mb-2 text-gray-200">קוד ההזמנה שלך:</p>
                        <p class="text-5xl font-black tracking-widest text-yellow-500">${code}</p>
                        <p class="text-sm mt-4 opacity-80 leading-relaxed border-t border-white/10 pt-4 text-gray-200">
                            נא לשמור את הקוד לביצוע שינויים, עדכונים או ביטול ההזמנה בעתיד.
                        </p>
                    </div>
                    <div class="space-y-3">
                        <button onclick="preparePrint()" class="w-full py-5 gold-gradient rounded-2xl font-bold text-navy shadow-lg flex items-center justify-center gap-3 hover:scale-[1.02] transition-transform">
                            <i data-lucide="printer" class="w-5 h-5"></i> הדפסת אישור השאלה
                        </button>
                        <button onclick="location.reload()" class="w-full py-4 text-gray-400 font-bold text-sm hover:text-navy transition-colors">חזרה לדף הבית</button>
                    </div>
                </div>`;
            lucide.createIcons();
        }

        function nextStep() { if (currentStep < 3) goToStep(currentStep + 1); else sendOrder(); }
        function prevStep() { goToStep(currentStep - 1); }

        function lookupOrder() {
            let code = prompt('נא להזין קוד הזמנה (4 ספרות):');
            if (!code) return;
            code = code.trim(); // ניקוי רווחים מיותרים מהקלט

            // בדיקה האם הנתונים נטענו
            if (!orders || orders.length === 0) {
                return showToast('המערכת עדיין טוענת נתונים, אנא נסה שוב בעוד מספר שניות');
            }

            // חיפוש אגרסיבי יותר: בודק מספר וריאציות של שמות עמודות וגם ממיר למחרוזת
            const order = orders.find(o => {
                // בדיקת כל השמות האפשריים לעמודה ב-Google Sheet
                const val = o.קוד_הזמנה || o['קוד_הזמנה'] || o['קוד הזמנה'] || o.orderCode || o['orderCode'] || o.code;
                return String(val).trim() === code;
            });

            if (!order) return showToast('הזמנה לא נמצאה במערכת. אנא בדוק את הקוד.');
            
            const customerName = order.שם_לקוח || order['שם_לקוח'] || 'לקוח';
            if (confirm(`נמצאה הזמנה על שם ${customerName}. לעבור לעריכה?`)) {
                activeOrderCode = code;
                
                try {
                    cart = JSON.parse(order.raw_cart || '[]');
                } catch(e) {
                    console.error("Error parsing cart json", e);
                    cart = [];
                    showToast('שגיאה בטעינת פריטי ההזמנה');
                }

                // המרת תאריכים בצורה בטוחה
                let pDate = order.תאריך_לקיחה || order['תאריך_לקיחה'];
                let rDate = order.תאריך_החזרה || order['תאריך_החזרה'];

                // אם התאריך מגיע כ-ISO string ארוך, חתוך אותו
                if (pDate && pDate.includes('T')) pDate = pDate.split('T')[0];
                if (rDate && rDate.includes('T')) rDate = rDate.split('T')[0];

                pendingFormData = { 
                    name: customerName, 
                    phone: order.טלפון || order['טלפון'], 
                    pDate: pDate, 
                    rDate: rDate, 
                    notes: order.הערות || order['הערות']
                };
                
                populatePrintArea(code);
                saveCart(); 
                updateCartUI(); 
                toggleCart(true);
                document.getElementById('cancel-order-area').classList.remove('hidden');
            }
        }

        async function cancelCurrentOrder() {
            if (!activeOrderCode || !confirm('האם אתה בטוח שברצונך לבטל ולמחוק את ההזמנה לצמיתות? פעולה זו לא ניתנת לביטול.')) return;
            try {
                await fetch(SCRIPT_URL, { 
                    method: 'POST', 
                    mode: 'no-cors', 
                    body: JSON.stringify({ action: "deleteOrder", orderCode: activeOrderCode }) 
                });
                localStorage.removeItem('gemach_cart');
                activeOrderCode = null;
                cart = [];
                showToast('ההזמנה בוטלה ונמחקה בהצלחה');
                setTimeout(() => location.reload(), 1500);
            } catch (e) {
                showToast('שגיאה בביטול ההזמנה');
            }
        }

        function populatePrintArea(code) {
            document.getElementById('print-order-id').innerText = 'קוד הזמנה: ' + code;
            document.getElementById('print-user-info').innerHTML = `
                <p><b>שם השואל:</b> ${pendingFormData.name}</p>
                <p><b>טלפון:</b> ${pendingFormData.phone}</p>
                <p><b>תקופת השאלה:</b> מ-${pendingFormData.pDate} עד ${pendingFormData.rDate}</p>
                <p><b>הערות:</b> ${pendingFormData.notes || 'אין'}</p>
            `;
            document.getElementById('print-items-list').innerHTML = cart.map(c => `
                <tr>
                    <td class="p-3 border border-gray-300 font-bold text-right">${c.שם_פריט}</td>
                    <td class="p-3 border border-gray-300 text-center font-bold">${c.qty}</td>
                </tr>
            `).join('');
        }

        function preparePrint() { window.print(); }

        function showAdminLogin() {
            const pass = prompt('סיסמה:');
            if (pass === '1234') {
                document.getElementById('admin-modal').classList.remove('hidden');
                renderAdminTable();
            }
        }

        function closeAdmin() { document.getElementById('admin-modal').classList.add('hidden'); }

        function renderAdminTable() {
            document.getElementById('admin-subtitle').innerText = "ניהול פריטים ומלאי";
            const content = document.getElementById('admin-content');
            content.innerHTML = `
                <div id="admin-form" class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-12 p-6 bg-gray-50 rounded-3xl border border-dashed border-gray-300">
                    <input type="hidden" id="edit-id">
                    <input type="text" id="new-name" placeholder="שם פריט" class="p-3 border rounded-xl text-sm outline-none text-right">
                    <input type="number" id="new-qty" placeholder="מלאי" class="p-3 border rounded-xl text-sm outline-none text-right">
                    <input type="text" id="new-cat" placeholder="קטגוריה" class="p-3 border rounded-xl text-sm outline-none text-right">
                    <input type="text" id="new-img" placeholder="קישור תמונה" class="p-3 border rounded-xl text-sm outline-none text-right">
                    <button onclick="saveItem()" id="save-btn" class="gold-gradient rounded-xl font-bold py-4 text-navy shadow-md">שמור פריט</button>
                </div>
                <div id="admin-table-list" class="space-y-3"></div>`;
            
            const list = document.getElementById('admin-table-list');
            list.innerHTML = inventory.map((item, idx) => {
                const isHidden = item.status === 'hidden';
                return `
                <div class="flex items-center gap-4 p-4 bg-white border rounded-2xl hover:border-gold transition-colors ${isHidden ? 'bg-gray-50 item-hidden' : ''}">
                    <img src="${formatImageUrl(item['תמונה'])}" onerror="this.src='${DEFAULT_IMG}'" class="w-16 h-16 rounded-lg object-cover border border-gray-200">
                    <div class="flex-1 text-right">
                        <div class="font-bold text-sm text-navy">${item['שם_פריט']} (מלאי: ${item.מלאי})</div>
                        ${isHidden ? '<span class="text-[9px] bg-gray-200 px-2 py-0.5 rounded text-gray-500">מוסתר מהקטלוג</span>' : ''}
                    </div>
                    <div class="flex gap-2">
                        <button onclick="toggleItemVisibility('${item['שם_פריט'].replace(/'/g, "\\'")}', '${item.status}')" 
                                class="p-2 hover:bg-gray-100 rounded-lg text-navy" title="${isHidden ? 'הצג בקטלוג' : 'הסתר מהקטלוג'}">
                            <i data-lucide="${isHidden ? 'eye-off' : 'eye'}" class="w-4 h-4 ${isHidden ? 'text-gray-400' : 'text-gold'}"></i>
                        </button>
                        <button onclick="editItem(${idx})" class="p-2 hover:bg-gray-100 rounded-lg text-navy"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                        <button onclick="deleteItem('${item['שם_פריט'].replace(/'/g, "\\'")}')" class="p-2 text-red-500 hover:bg-red-50 rounded-lg"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </div>
                </div>`;
            }).join('');
            lucide.createIcons();
        }

        async function toggleItemVisibility(name, currentStatus) {
            const newStatus = currentStatus === 'hidden' ? 'active' : 'hidden';
            const item = inventory.find(i => i['שם_פריט'] === name);
            if (item) item.status = newStatus;
            renderAdminTable();
            renderGrid();
            try {
                await fetch(SCRIPT_URL, { 
                    method: 'POST', 
                    body: JSON.stringify({
                        action: "editItem", 
                        שם_פריט: name, 
                        status: newStatus,
                        old_name: name,
                        מלאי: item.מלאי,
                        קטגוריה: item['קטגוריה'],
                        תמונה: item['תמונה']
                    }) 
                });
            } catch (e) { showToast('שגיאה בעדכון הסטטוס בשרת'); }
        }

        function showOrdersHistory() {
            document.getElementById('admin-subtitle').innerText = "היסטוריית הזמנות מפורטת";
            const content = document.getElementById('admin-content');
            
            if (orders.length === 0) {
                content.innerHTML = `<div class="py-20 text-center opacity-50 text-navy font-bold">אין הזמנות עדיין</div>`;
                return;
            }

            let html = `
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-lg serif italic text-navy">רשימת השאלות</h3>
                    <div class="flex gap-3">
                        <button onclick="renderAdminTable()" class="px-4 py-2 gold-gradient text-navy rounded-xl text-xs font-bold shadow-md hover:scale-105 transition-all">חזור לניהול מלאי</button>
                        <button onclick="closeAdmin()" class="p-2 bg-gray-100 text-navy rounded-xl hover:bg-gray-200 transition-colors shadow-sm"><i data-lucide="x" class="w-5 h-5"></i></button>
                    </div>
                </div>
                <div class="overflow-x-auto rounded-2xl border border-gray-100 shadow-sm">
                    <table class="w-full text-sm border-collapse bg-white">
                        <thead class="bg-navy text-blue-400 text-right">
                            <tr>
                                <th class="p-4 border-b border-white/10 text-right">לקוח</th>
                                <th class="p-4 border-b border-white/10 text-right">טלפון</th>
                                <th class="p-4 border-b border-white/10 text-center">איסוף</th>
                                <th class="p-4 border-b border-white/10 text-center">החזרה</th>
                                <th class="p-4 border-b border-white/10 text-right">פריטים</th>
                                <th class="p-4 border-b border-white/10 text-center">קוד הזמנה</th>                            
                            </tr>
                        </thead>
                        <tbody>`;
            
            const sortedOrders = [...orders].reverse();

            sortedOrders.forEach(o => {
                const cleanPickup = (o.תאריך_לקיחה || o['תאריך_לקיחה'] || "").split('T')[0].split(' ')[0];
                const cleanReturn = (o.תאריך_החזרה || o['תאריך_החזרה'] || "").split('T')[0].split(' ')[0];
                const code = o.קוד_הזמנה || o['קוד_הזמנה'] || o.orderCode || '---';

                html += `
                    <tr class="border-b hover:bg-gray-50 transition-colors text-navy text-right">
                        <td class="p-4 font-bold">${o.שם_לקוח || o['שם_לקוח']}</td>
                        <td class="p-4 font-mono text-xs">${o.טלפון || o['טלפון']}</td>
                        <td class="p-4 text-center text-xs bg-gray-50/50 font-bold">${cleanPickup}</td>
                        <td class="p-4 text-center text-xs bg-gray-50/50 font-bold">${cleanReturn}</td>
                        <td class="p-4 text-[11px] leading-relaxed max-w-xs text-right">${(o.פריטים || o['פריטים'] || "").replace(/, /g, '<br>')}</td>
                        <td class="p-4 text-center font-bold text-gold bg-gray-50/30">${code}</td>
                    </tr>`;
            });
            
            html += `</tbody></table></div>`;
            content.innerHTML = html;
            lucide.createIcons();
        }

        async function saveItem() {
            const name = document.getElementById('new-name').value;
            const qty = document.getElementById('new-qty').value;
            if(!name || !qty) return showToast('נא למלא שם ומלאי');

            const payload = {
                action: document.getElementById('edit-id').value ? "editItem" : "addItem",
                שם_פריט: name,
                מלאי: qty,
                קטגוריה: document.getElementById('new-cat').value,
                תמונה: document.getElementById('new-img').value,
                old_name: document.getElementById('edit-id').value,
                status: 'active'
            };
            
            const btn = document.getElementById('save-btn');
            btn.disabled = true;
            btn.innerText = 'שומר...';

            try {
                await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
                await init(); 
                renderAdminTable();
                showToast('הפריט נשמר בהצלחה');
            } catch(e) {
                showToast('שגיאה בשמירה');
            } finally {
                btn.disabled = false;
                btn.innerText = 'שמור פריט';
            }
        }

        function editItem(idx) {
            const i = inventory[idx];
            document.getElementById('new-name').value = i['שם_פריט'];
            document.getElementById('new-qty').value = i.מלאי;
            document.getElementById('new-cat').value = i['קטגוריה'];
            document.getElementById('new-img').value = i['תמונה'];
            document.getElementById('edit-id').value = i['שם_פריט'];
            document.getElementById('save-btn').innerText = 'עדכן שינויים';
            document.getElementById('admin-form').scrollIntoView({behavior:'smooth'});
        }

        async function deleteItem(name) {
            if (confirm('למחוק לצמיתות?')) {
                await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({action: "deleteItem", שם_פריט: name}) });
                await init(); 
                renderAdminTable();
            }
        }

        function saveCart() { localStorage.setItem('gemach_cart', JSON.stringify(cart)); updateCartUI(); }
        function updateCartUI() {
            const count = document.getElementById('cart-count');
            const total = cart.reduce((a, c) => a + c.qty, 0);
            count.innerText = total; count.classList.toggle('hidden', total === 0);
        }

        function handleSearch() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const filtered = inventory.filter(i => 
                i.status !== 'hidden' && 
                (i.שם_פריט.toLowerCase().includes(term) || (i.קטגוריה && i.קטגוריה.toLowerCase().includes(term)))
            );
            renderGrid(filtered);
        }

        function showToast(m) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = m;
            t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000);
        }

        window.onload = init;
    </script>
</body>
</html>
